<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextInvest AI - リアルタイム投資分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #050505; color: #ffffff; overflow-x: hidden; scroll-behavior: smooth; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 28px; }
        .glass-card-hover:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.06); transition: all 0.4s ease; }
        #fluid-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .gauge-container { position: relative; width: 180px; height: 90px; overflow: hidden; }
        .gauge-bg { width: 180px; height: 180px; border-radius: 50%; border: 12px solid rgba(255,255,255,0.05); border-bottom-color: transparent; border-left-color: transparent; transform: rotate(-45deg); }
        .gauge-fill { position: absolute; top: 0; width: 180px; height: 180px; border-radius: 50%; border: 12px solid transparent; border-top-color: #3b82f6; border-right-color: #10b981; transform: rotate(45deg); transition: transform 2.0s cubic-bezier(0.19, 1, 0.22, 1); }
        .tab-btn.active { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); color: #60a5fa; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <canvas id="fluid-canvas"></canvas>

    <!-- Navigation -->
    <nav class="fixed w-full z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center glass-card px-8 py-3 bg-black/20">
            <div class="text-2xl font-black flex items-center gap-2">
                <i data-lucide="zap" class="text-blue-400 fill-blue-400"></i> NEXTINVEST AI
            </div>
            <div class="hidden md:flex gap-8 text-xs font-medium uppercase tracking-widest">
                <a href="#market" class="hover:text-blue-300 transition">Market</a>
                <a href="#analysis" class="hover:text-blue-300 transition">Analytics</a>
                <a href="#rankings" class="hover:text-blue-300 transition">Rankings</a>
                <a href="#nisa" class="hover:text-blue-300 transition">NISA</a>
                <a href="#glossary" class="hover:text-blue-300 transition">Glossary</a>
            </div>
            <button class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold text-sm">LIVE</button>
        </div>
    </nav>

    <!-- Hero / Dashboard -->
    <section id="market" class="relative pt-40 pb-20 px-6">
        <div class="max-w-6xl mx-auto grid lg:grid-cols-2 gap-16 items-center">
            <div>
                <h1 class="text-5xl md:text-7xl font-extrabold mb-8 leading-tight">市場の「今」を<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">AIが即時解析。</span></h1>
                <p class="text-xl text-gray-400 mb-12">最新の Fear & Greed Index や為替変動をダッシュボードに自動反映。</p>
                <div class="flex gap-4">
                    <a href="#analysis" class="bg-blue-600 px-8 py-4 rounded-full font-bold hover:bg-blue-500 transition">AI分析を開始</a>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-6 flex flex-col items-center justify-center text-center">
                    <div class="text-[10px] font-bold text-gray-500 mb-4 uppercase flex items-center gap-2">Fear & Greed Index <span id="fg-loading" class="w-2 h-2 bg-blue-500 rounded-full animate-ping hidden"></span></div>
                    <div class="gauge-container">
                        <div class="gauge-bg"></div>
                        <div id="fg-fill" class="gauge-fill" style="transform: rotate(45deg);"></div>
                        <div class="absolute bottom-0 left-0 w-full text-center">
                            <div class="text-3xl font-black" id="fg-value">--</div>
                            <div class="text-[10px] text-gray-400 font-bold uppercase" id="fg-label">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-6 flex flex-col justify-between">
                    <div>
                        <div class="text-[10px] font-bold text-gray-500 mb-1 uppercase">USD / JPY</div>
                        <div class="text-3xl font-black mb-1" id="fx-rate">---.--</div>
                        <div class="text-xs font-bold" id="fx-change">--.--</div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-white/5 text-[10px] text-gray-500 flex justify-between">
                        <span>Updated</span>
                        <span id="update-time">--:--:--</span>
                    </div>
                </div>
                <div class="glass-card p-6 col-span-2 flex items-center justify-between">
                    <div class="flex gap-8">
                        <div><div class="text-[10px] font-bold text-gray-500 uppercase">S&P 500</div><div class="text-xl font-black" id="idx-sp500">----.--</div></div>
                        <div><div class="text-[10px] font-bold text-gray-500 uppercase">Nikkei 225</div><div class="text-xl font-black" id="idx-nikkei">----.--</div></div>
                    </div>
                    <button onclick="fetchMarketData()" class="text-blue-400 hover:scale-110 transition"><i data-lucide="refresh-cw" size="20"></i></button>
                </div>
            </div>
        </div>
    </section>

    <!-- Analysis -->
    <section id="analysis" class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-1/3 flex flex-col gap-3">
                    <h2 class="text-3xl font-bold mb-4">AI分析ツール</h2>
                    <button onclick="switchTab('us')" id="tab-us" class="tab-btn active p-5 glass-card text-left flex items-center gap-4 glass-card-hover"><i data-lucide="globe"></i>米国株</button>
                    <button onclick="switchTab('jp')" id="tab-jp" class="tab-btn p-5 glass-card text-left flex items-center gap-4 glass-card-hover"><i data-lucide="flag"></i>日本株</button>
                    <button onclick="switchTab('fund')" id="tab-fund" class="tab-btn p-5 glass-card text-left flex items-center gap-4 glass-card-hover"><i data-lucide="layers"></i>投資信託</button>
                </div>
                <div class="w-full lg:w-2/3 glass-card p-8">
                    <div class="relative mb-8">
                        <input id="stock-input" type="text" placeholder="銘柄名やコードを入力..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-5 px-6 focus:ring-2 focus:ring-blue-500 text-xl font-light">
                        <button onclick="runAnalysis()" class="absolute right-3 top-3 bg-blue-600 px-8 py-3 rounded-xl font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-500/20">分析実行</button>
                    </div>
                    <div id="analysis-result" class="min-h-[300px] flex flex-col items-center justify-center text-gray-500 border-2 border-dashed border-white/10 rounded-3xl">
                        <i data-lucide="cpu" size="48" class="mb-4 opacity-10"></i>
                        <p>分析対象を入力してください</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Rankings Section -->
    <section id="rankings" class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold mb-10 flex items-center gap-3">
                <i data-lucide="award" class="text-yellow-400"></i>
                日本株 優待・配当利回りランキング
            </h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="glass-card p-8 glass-card-hover relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 opacity-5"><i data-lucide="trending-up" size="120"></i></div>
                    <div class="text-blue-400 font-bold mb-2">RANK #1</div>
                    <h3 class="text-xl font-bold mb-1">9101 日本郵船</h3>
                    <p class="text-sm text-gray-400 mb-4">海運業の世界的リーダー。非常に高い配当還元が魅力。</p>
                    <div class="text-2xl font-black text-emerald-400">利回り 14.2%</div>
                </div>
                <div class="glass-card p-8 glass-card-hover relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 opacity-5"><i data-lucide="trending-up" size="120"></i></div>
                    <div class="text-blue-400 font-bold mb-2">RANK #2</div>
                    <h3 class="text-xl font-bold mb-1">2914 JT</h3>
                    <p class="text-sm text-gray-400 mb-4">安定的な利益率。優待は廃止されたが、圧倒的高配当。</p>
                    <div class="text-2xl font-black text-emerald-400">利回り 6.8%</div>
                </div>
                <div class="glass-card p-8 glass-card-hover relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 opacity-5"><i data-lucide="gift" size="120"></i></div>
                    <div class="text-blue-400 font-bold mb-2">RANK #3</div>
                    <h3 class="text-xl font-bold mb-1">8591 オリックス</h3>
                    <p class="text-sm text-gray-400 mb-4">リース・金融最大手。優待のカタログギフトは最終盤だが人気。</p>
                    <div class="text-2xl font-black text-emerald-400">総合評価 A+</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Simulator -->
    <section id="nisa" class="py-20 px-6 bg-blue-950/20">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-4xl font-bold text-center mb-12">NISA 将来シミュレーター</h2>
            <div class="grid lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2 glass-card p-8 space-y-8">
                    <div><label class="text-sm text-gray-400">積立/月: <span id="val-monthly" class="text-blue-400">3</span>万</label><input type="range" id="input-monthly" min="1" max="30" value="3" class="mt-4"></div>
                    <div><label class="text-sm text-gray-400">利回り: <span id="val-rate" class="text-emerald-400">5</span>%</label><input type="range" id="input-rate" min="0.1" max="15" value="5" step="0.1" class="mt-4"></div>
                    <div><label class="text-sm text-gray-400">期間: <span id="val-years" class="text-purple-400">20</span>年</label><input type="range" id="input-years" min="1" max="40" value="20" class="mt-4"></div>
                    <div class="pt-8 border-t border-white/10"><div class="text-4xl font-black" id="val-total">0円</div><p class="text-emerald-400 font-bold text-sm" id="val-profit">+0円 益</p></div>
                </div>
                <div class="lg:col-span-3 glass-card p-8 min-h-[400px]"><canvas id="nisaChart"></canvas></div>
            </div>
        </div>
    </section>

    <!-- Glossary Section -->
    <section id="glossary" class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold mb-10 text-center uppercase tracking-widest">Investment Glossary</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="glass-card p-6">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> NISA</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">少額投資非課税制度。通常、投資益には約20%の税金がかかりますが、NISA口座内での利益はすべて非課税となります。2024年から大幅に枠が拡大されました。</p>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> Fear & Greed Index</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">投資家の心理を「恐怖(0)」から「強欲(100)」の間で数値化した指標。数値が低いほど絶望的（買い時）、高いほど過熱気味（売り時）と判断されます。</p>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> 配当利回り</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">投資した金額に対して、1年間でどれだけの配当金を受け取れるかを示す指標。一般的に3〜4%以上が高配当銘柄と呼ばれます。</p>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> 投資信託</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">多くの投資家から集めた資金を、運用のプロが一括して株式や債券に投資する商品。少額から分散投資ができるのが最大の特徴です。</p>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> 株主優待</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">企業が株主に対して、自社製品やサービス券、特産品などを贈る日本独自の制度。配当とは別の投資還元として人気があります。</p>
                </div>
                <div class="glass-card p-6">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> ドル円為替</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">日本円と米ドルの交換比率。円安は輸出企業（トヨタ等）に有利、円高は輸入企業や米国株投資家に有利に働きます。</p>
                </div>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-[10px] text-gray-600 uppercase tracking-widest border-t border-white/5">
        <p>© 2026 NextInvest AI. Real-time insights for your financial future.</p>
    </footer>

    <script>
        // API Proxy Call
        async function fetchAPI(payload) {
            const res = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('API Error');
            return await res.json();
        }

        async function fetchMarketData() {
            const loadingEl = document.getElementById('fg-loading');
            if (loadingEl) loadingEl.classList.remove('hidden');
            try {
                const data = await fetchAPI({ type: 'market_data' });
                document.getElementById('fg-value').innerText = data.fgValue || '--';
                document.getElementById('fg-label').innerText = data.fgLabel || 'Unknown';
                const rotation = data.fgValue ? (data.fgValue/100)*180+45 : 45;
                document.getElementById('fg-fill').style.transform = `rotate(${rotation}deg)`;
                document.getElementById('fx-rate').innerText = data.usdjpy || '---.--';
                document.getElementById('fx-change').innerText = data.usdjpyChange || '--.--';
                document.getElementById('idx-sp500').innerText = data.sp500 || '----.--';
                document.getElementById('idx-nikkei').innerText = data.nikkei || '----.--';
                document.getElementById('update-time').innerText = new Date().toLocaleTimeString();
            } catch (e) {
                document.getElementById('fg-label').innerText = "Fetch Error";
            } finally {
                if (loadingEl) loadingEl.classList.add('hidden');
            }
        }

        let currentTab = 'us';
        function switchTab(t) { 
            currentTab = t; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById(`tab-${t}`).classList.add('active'); 
            const input = document.getElementById('stock-input');
            if (t === 'us') input.placeholder = "例: NVDA, Apple, Tesla...";
            else if (t === 'jp') input.placeholder = "例: 7203, トヨタ, 銘柄番号...";
            else input.placeholder = "例: eMAXIS Slim, オルカン...";
        }

        async function runAnalysis() {
            const query = document.getElementById('stock-input').value;
            if (!query) return;
            const resDiv = document.getElementById('analysis-result');
            resDiv.innerHTML = `<div class="animate-spin h-8 w-8 border-t-2 border-blue-500 rounded-full mb-4"></div><p>最新の市場環境と併せて解析中...</p>`;
            
            const prompt = currentTab === 'us' ? "米国株現状分析と見通し。" : currentTab === 'jp' ? "日本株の利回り・優待・見通し。" : "投資信託の評価。";

            try {
                const data = await fetchAPI({ type: 'analysis', query, prompt });
                resDiv.innerHTML = `<div class="w-full text-left p-6 leading-relaxed fade-in text-sm text-gray-200">${data.text}</div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (e) {
                resDiv.innerHTML = `<p class="text-red-400">エラーが発生しました。Vercelの環境変数を確認してください。</p>`;
            }
        }

        // --- NISA & Graphics ---
        let nisaChart;
        function initChart() {
            const ctx = document.getElementById('nisaChart').getContext('2d');
            nisaChart = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: [], datasets: [ { label: '元本', data: [], backgroundColor: '#2563eb', stack: '1' }, { label: '利益', data: [], backgroundColor: '#10b981', stack: '1' } ] }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        x: { grid: { display: false }, ticks: { color: '#555' } }, 
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#555', callback: v => (v/10000)+'万' } } 
                    }, 
                    plugins: { legend: { display: false } } 
                } 
            });
        }

        function updateSim() {
            const m = parseInt(document.getElementById('input-monthly').value) * 10000;
            const r = parseFloat(document.getElementById('input-rate').value) / 100 / 12;
            const y = parseInt(document.getElementById('input-years').value);
            document.getElementById('val-monthly').innerText = document.getElementById('input-monthly').value;
            document.getElementById('val-rate').innerText = document.getElementById('input-rate').value;
            document.getElementById('val-years').innerText = y;
            let labels = [], pArr = [], rArr = [], total = 0, pTotal = 0;
            for(let i=1; i<=y; i++) { 
                labels.push(i+'Y'); 
                for(let j=0; j<12; j++) { total = (total + m) * (1 + r); pTotal += m; } 
                pArr.push(pTotal); 
                rArr.push(Math.max(0, total - pTotal)); 
            }
            nisaChart.data.labels = labels; 
            nisaChart.data.datasets[0].data = pArr; 
            nisaChart.data.datasets[1].data = rArr; 
            nisaChart.update();
            document.getElementById('val-total').innerText = Math.round(total).toLocaleString()+'円';
            document.getElementById('val-profit').innerText = '+'+Math.round(total-pTotal).toLocaleString()+'円 益';
        }

        function initThree() {
            const canvas = document.getElementById('fluid-canvas');
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            const scene = new THREE.Scene();
            const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            const uniforms = { u_time: { value: 0 }, u_mouse: { value: new THREE.Vector2(0,0) }, u_resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) } };
            const material = new THREE.ShaderMaterial({ uniforms, fragmentShader: `uniform float u_time; uniform vec2 u_mouse; uniform vec2 u_resolution; void main() { vec2 uv = gl_FragCoord.xy / u_resolution.xy; float d = distance(uv, u_mouse/u_resolution.xy); vec3 c1 = vec3(0.01, 0.04, 0.08); vec3 c2 = vec3(0.0, 0.3, 0.6); float r = smoothstep(0.7, 0.0, d) * 0.4; gl_FragColor = vec4(mix(c1, c2, r + sin(u_time*0.5+uv.x*4.0)*0.03), 1.0); }` });
            scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2), material));
            window.addEventListener('mousemove', e => uniforms.u_mouse.value.set(e.clientX, window.innerHeight - e.clientY));
            function animate(t) { uniforms.u_time.value = t*0.001; renderer.render(scene, camera); requestAnimationFrame(animate); }
            animate(0);
        }

        window.onload = () => { 
            if (typeof lucide !== 'undefined') lucide.createIcons(); 
            initThree(); 
            initChart(); 
            updateSim(); 
            fetchMarketData(); 
            ['monthly', 'rate', 'years'].forEach(id => {
                const el = document.getElementById('input-'+id);
                if (el) el.addEventListener('input', updateSim);
            });
        };
    </script>
</body>
</html>