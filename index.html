<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextInvest AI - リアルタイム投資分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #050505; color: #ffffff; overflow-x: hidden; scroll-behavior: smooth; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 28px; transition: all 0.4s ease; }
        .glass-card-hover:hover { transform: translateY(-5px); background: rgba(255, 255, 255, 0.06); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        #fluid-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .tab-btn.active { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); color: #60a5fa; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; cursor: pointer; }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <canvas id="fluid-canvas"></canvas>

    <!-- Navigation -->
    <nav class="fixed w-full z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center glass-card px-8 py-3 bg-black/20">
            <div class="text-2xl font-black flex items-center gap-2">
                <i data-lucide="zap" class="text-blue-400 fill-blue-400"></i> NEXTINVEST AI
            </div>
            <div class="hidden md:flex gap-8 text-xs font-medium uppercase tracking-widest">
                <a href="#hero" class="hover:text-blue-300">Top</a>
                <a href="#analysis" class="hover:text-blue-300">Analytics</a>
                <a href="#rankings" class="hover:text-blue-300">Rankings</a>
                <a href="#nisa" class="hover:text-blue-300">NISA</a>
                <a href="#glossary" class="hover:text-blue-300">Glossary</a>
            </div>
            <button class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold text-sm transition hover:bg-blue-500">LIVE</button>
        </div>
    </nav>

    <!-- Hero Section -->
    <section id="hero" class="relative pt-60 pb-40 px-6">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-5xl md:text-8xl font-extrabold mb-8 leading-tight">
                AIが描く、<br><span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">資産運用の未来。</span>
            </h1>
            <p class="text-xl text-gray-400 mb-12 max-w-2xl mx-auto">
                最新の市場動向とAIアルゴリズムを融合。膨大なデータから、あなたにとって最適な投資判断をリアルタイムでサポートします。
            </p>
            <div class="flex flex-wrap justify-center gap-6">
                <a href="#analysis" class="bg-blue-600 px-10 py-5 rounded-full font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-500/20 text-lg">AI分析を開始</a>
                <a href="#rankings" class="glass-card px-10 py-5 rounded-full font-bold hover:bg-white/10 transition text-lg border-white/20">最新ランキングを見る</a>
            </div>
        </div>
    </section>

    <!-- Analysis Section -->
    <section id="analysis" class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-1/3 flex flex-col gap-3">
                    <h2 class="text-3xl font-bold mb-4">AI分析ツール</h2>
                    <button onclick="switchTab('us')" id="tab-us" class="tab-btn active p-5 glass-card text-left flex items-center gap-4 glass-card-hover"><i data-lucide="globe"></i>米国個別株</button>
                    <button onclick="switchTab('jp')" id="tab-jp" class="tab-btn p-5 glass-card text-left flex items-center gap-4 glass-card-hover"><i data-lucide="flag"></i>日本個別株</button>
                    <button onclick="switchTab('fund')" id="tab-fund" class="tab-btn p-5 glass-card text-left flex items-center gap-4 glass-card-hover"><i data-lucide="layers"></i>投資信託</button>
                </div>
                <div class="w-full lg:w-2/3 glass-card p-8">
                    <div class="relative mb-8">
                        <input id="stock-input" type="text" placeholder="銘柄名やコードを入力..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-5 px-6 focus:ring-2 focus:ring-blue-500 text-xl font-light">
                        <button onclick="runAnalysis()" class="absolute right-3 top-3 bg-blue-600 hover:bg-blue-500 px-8 py-3 rounded-xl font-bold hover:bg-blue-500 transition shadow-lg shadow-blue-500/20">分析実行</button>
                    </div>
                    <div id="analysis-result" class="min-h-[400px] flex flex-col items-center justify-center text-gray-500 border-2 border-dashed border-white/10 rounded-3xl">
                        <i data-lucide="cpu" size="48" class="mb-4 opacity-10"></i>
                        <p>分析対象を入力してください</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Rankings Section -->
    <section id="rankings" class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-end mb-10">
                <h2 class="text-3xl font-bold flex items-center gap-3">
                    <i data-lucide="award" class="text-yellow-400"></i>
                    日本株 配当利回りランキング (AI分析)
                </h2>
                <div class="text-xs text-gray-500 font-mono" id="ranking-update-time">Loading...</div>
            </div>
            <div class="grid md:grid-cols-3 gap-6" id="ranking-container">
                <div class="col-span-full py-20 flex flex-col items-center opacity-50">
                    <div class="animate-spin h-8 w-8 border-t-2 border-blue-500 rounded-full mb-4"></div>
                    <p>AIが最新の利回りデータを取得中...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Simulator Section -->
    <section id="nisa" class="py-20 px-6 bg-blue-950/20">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-4xl font-bold text-center mb-12">NISA 将来資産シミュレーター</h2>
            <div class="grid lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2 glass-card p-8 space-y-8">
                    <div><label class="text-sm text-gray-400">積立/月: <span id="val-monthly" class="text-blue-400">3</span>万</label><input type="range" id="input-monthly" min="1" max="30" value="3" class="mt-4"></div>
                    <div><label class="text-sm text-gray-400">想定利回り: <span id="val-rate" class="text-emerald-400">5</span>%</label><input type="range" id="input-rate" min="0.1" max="15" value="5" step="0.1" class="mt-4"></div>
                    <div><label class="text-sm text-gray-400">積立期間: <span id="val-years" class="text-purple-400">20</span>年</label><input type="range" id="input-years" min="1" max="40" value="20" class="mt-4"></div>
                    <div class="pt-8 border-t border-white/10"><div class="text-4xl font-black" id="val-total">0円</div><p class="text-emerald-400 font-bold text-sm" id="val-profit">+0円 益</p></div>
                </div>
                <div class="lg:col-span-3 glass-card p-8 min-h-[400px]"><canvas id="nisaChart"></canvas></div>
            </div>
        </div>
    </section>

    <!-- Glossary Section -->
    <section id="glossary" class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <h2 class="text-3xl font-bold mb-10 text-center uppercase tracking-widest border-b border-white/10 pb-4">Investment Glossary (用語解説)</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="glass-card p-6 glass-card-hover">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> NISA</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">少額投資非課税制度。通常約20%かかる投資益への税金がゼロになる制度です。新NISAでは期間が無期限化されました。</p>
                </div>
                <div class="glass-card p-6 glass-card-hover">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> 配当利回り</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">株価に対する年間配当金の割合。3%以上が一般的に高配当とされ、企業の利益還元姿勢を見る重要な指標です。</p>
                </div>
                <div class="glass-card p-6 glass-card-hover">
                    <h3 class="font-bold text-blue-400 mb-2 flex items-center gap-2"><i data-lucide="help-circle" size="18"></i> 投資信託</h3>
                    <p class="text-sm text-gray-400 leading-relaxed">運用のプロが管理・投資する商品。少額から分散投資が可能です。</p>
                </div>
            </div>
        </div>
    </section>

    <footer class="py-12 text-center text-[10px] text-gray-600 uppercase tracking-widest border-t border-white/5">
        <p>© 2026 NextInvest AI. Real-time insights powered by AI.</p>
    </footer>

    <script>
        // API Proxy Call
        async function fetchAPI(payload) {
            try {
                const isLocal = window.location.protocol.startsWith('blob') || window.location.hostname === 'localhost';
                if (isLocal) {
                    if (payload.type === 'ranking') return { text: '<div class="col-span-full py-10 glass-card text-center opacity-60">プレビュー環境ではダミーのランキングが表示されます。<br>Vercelにデプロイすると実際のAIデータが読み込まれます。</div>' };
                    return { text: "デプロイ後に動作します。" };
                }

                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorJson = await res.json().catch(() => ({}));
                    throw new Error(errorJson.error || `HTTP Error: ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                console.error('fetchAPI Error:', error.message);
                throw error;
            }
        }

        async function fetchRankingData() {
            const container = document.getElementById('ranking-container');
            const timeEl = document.getElementById('ranking-update-time');
            try {
                const prompt = "今日現在の日本株高配当利回りランキング上位3位を調査し、HTML（glass-cardクラスを使用）形式で出力してください。優待情報は一切含めないでください。";
                const data = await fetchAPI({ type: 'ranking', query: '日本株配当ランキング', prompt: prompt });
                container.innerHTML = data.text;
                if (timeEl) timeEl.innerText = `Updated: ${new Date().toLocaleTimeString()}`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (e) {
                container.innerHTML = `<p class="col-span-full text-center text-red-400">取得失敗。Vercel環境変数を確認してください。</p>`;
            }
        }

        let currentTab = 'us';
        function switchTab(t) { 
            currentTab = t; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById(`tab-${t}`).classList.add('active'); 
            const input = document.getElementById('stock-input');
            if (t === 'us') input.placeholder = "例: NVDA, Apple, Tesla...";
            else if (t === 'jp') input.placeholder = "例: 7203, トヨタ, 銘柄番号...";
            else input.placeholder = "例: eMAXIS Slim, オルカン...";
        }

        async function runAnalysis() {
            const query = document.getElementById('stock-input').value;
            if (!query) return;
            const resDiv = document.getElementById('analysis-result');
            resDiv.innerHTML = `<div class="animate-spin h-8 w-8 border-t-2 border-blue-500 rounded-full mb-4"></div><p>最新の市場環境と併せて解析中...</p>`;
            
            const prompt = currentTab === 'us' ? "米国株現状分析。" : currentTab === 'jp' ? "日本株の配当利回り・見通し。" : "投資信託の評価。";

            try {
                const data = await fetchAPI({ type: 'analysis', query, prompt });
                resDiv.innerHTML = `<div class="w-full text-left p-6 leading-relaxed fade-in text-sm text-gray-200">${data.text}</div>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } catch (e) {
                resDiv.innerHTML = `<p class="text-red-400">解析に失敗しました。Vercelの環境変数を確認してください。</p>`;
            }
        }

        // --- NISA Simulator ---
        let nisaChart;
        function initChart() {
            const canvas = document.getElementById('nisaChart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            nisaChart = new Chart(ctx, { 
                type: 'bar', 
                data: { labels: [], datasets: [ { label: '元本', data: [], backgroundColor: '#2563eb', stack: '1' }, { label: '利益', data: [], backgroundColor: '#10b981', stack: '1' } ] }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false }, ticks: { color: '#555' } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#555', callback: v => (v/10000)+'万' } } }, plugins: { legend: { display: false } } } 
            });
        }

        function updateSim() {
            const inputM = document.getElementById('input-monthly');
            const inputR = document.getElementById('input-rate');
            const inputY = document.getElementById('input-years');
            if(!inputM || !inputR || !inputY) return;

            const m = parseInt(inputM.value) * 10000;
            const r = parseFloat(inputR.value) / 100 / 12;
            const y = parseInt(inputY.value);

            document.getElementById('val-monthly').innerText = inputM.value;
            document.getElementById('val-rate').innerText = inputR.value;
            document.getElementById('val-years').innerText = y;

            let labels = [], pArr = [], rArr = [], total = 0, pTotal = 0;
            for(let i=1; i<=y; i++) { 
                labels.push(i+'Y'); 
                for(let j=0; j<12; j++) { total = (total + m) * (1 + r); pTotal += m; } 
                pArr.push(pTotal); 
                rArr.push(Math.max(0, total - pTotal)); 
            }
            if(nisaChart) {
                nisaChart.data.labels = labels; 
                nisaChart.data.datasets[0].data = pArr; 
                nisaChart.data.datasets[1].data = rArr; 
                nisaChart.update();
            }
            document.getElementById('val-total').innerText = Math.round(total).toLocaleString()+'円';
            document.getElementById('val-profit').innerText = '+'+Math.round(total - pTotal).toLocaleString()+'円 益';
        }

        // --- Three.js Background ---
        function initThree() {
            const canvas = document.getElementById('fluid-canvas');
            if (!canvas || typeof THREE === 'undefined') return;

            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            const scene = new THREE.Scene();
            const camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
            const uniforms = { u_time: { value: 0 }, u_mouse: { value: new THREE.Vector2(0,0) }, u_resolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) } };
            const material = new THREE.ShaderMaterial({ uniforms, fragmentShader: `uniform float u_time; uniform vec2 u_mouse; uniform vec2 u_resolution; void main() { vec2 uv = gl_FragCoord.xy / u_resolution.xy; float d = distance(uv, u_mouse/u_resolution.xy); vec3 c1 = vec3(0.01, 0.04, 0.08); vec3 c2 = vec3(0.0, 0.35, 0.7); float r = smoothstep(0.7, 0.0, d) * 0.45; gl_FragColor = vec4(mix(c1, c2, r + sin(u_time*0.5+uv.x*4.0)*0.03), 1.0); }` });
            scene.add(new THREE.Mesh(new THREE.PlaneGeometry(2,2), material));
            window.addEventListener('mousemove', e => uniforms.u_mouse.value.set(e.clientX, window.innerHeight - e.clientY));
            window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); uniforms.u_resolution.value.set(window.innerWidth, window.innerHeight); });
            function animate(t) { uniforms.u_time.value = t*0.001; renderer.render(scene, camera); requestAnimationFrame(animate); }
            animate(0);
        }

        window.onload = () => { 
            if (typeof lucide !== 'undefined') lucide.createIcons(); 
            initThree(); 
            initChart(); 
            updateSim(); 
            fetchRankingData();
            ['monthly', 'rate', 'years'].forEach(id => {
                const el = document.getElementById('input-'+id);
                if (el) el.addEventListener('input', updateSim);
            });
        };
    </script>
</body>
</html>